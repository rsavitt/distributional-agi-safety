# Kernel Market v2 Scenario
# Fixes modeling gaps identified by comparing against real LeetGPU/KernelBench:
#   1. Correlated speedup-cheating (cheaters look better because they cheat)
#   2. Split functional/OOD test regime (proxy only sees functional tests)
#   3. Tolerance exploitation via atol/rtol margin
#   4. Lighter governance baseline (room for tax effects to show)
#   5. Rebalanced proxy weights (speedup = dominant ranking signal)
#   6. Revised agent mix (more adversarial pressure)
#
# Proxy signal mapping (LeetGPU → SWARM observables):
#   task_progress_delta  ← fraction of functional tests passed (visible to proxy)
#   rework_count         ← compilation failures before success
#   verifier_rejections  ← test failures found by verifier/audit (OOD revealed here)
#   tool_misuse_flags    ← precision hacks detected (tolerance exploitation)
#   engagement_delta     ← apparent speedup (includes cheat bonus!)
#
# Adverse selection mechanism:
#   Adversarial agents get cheat_speedup_bonus (+0.4) on the engagement signal
#   when they cheat, making their submissions look BETTER to the proxy.
#   Meanwhile, OOD tests (hidden from proxy) show they fail at 0.30 rate.
#   Audits reveal OOD results and strip the cheat bonus → true speedup.
#   This creates a genuine proxy gap that governance can address.

scenario_id: kernel_market_v2
description: >
  GPU kernel marketplace v2 with correlated speedup-cheating, split
  functional/OOD test regime, and tolerance exploitation. Lighter
  governance baseline gives room for tax effects to show signal.
motif: kernel_market

simulation:
  n_epochs: 20
  steps_per_epoch: 10
  seed: 42

# Marketplace: challenges posted as bounties, kernels submitted as bids
marketplace:
  enabled: true
  escrow_fee_rate: 0.03
  min_bounty_amount: 2.0
  max_bids_per_bounty: 8
  bid_deadline_epochs: 2
  dispute_resolution_epochs: 1
  auto_expire_bounties: true
  dispute_default_split: 0.5

# Payoff: same structure, slightly higher harm for wrong kernels
payoff:
  s_plus: 3.0       # Correct + performant kernel value
  s_minus: 2.5      # Wrong kernel causes production failures (was 2.0)
  h: 5.0            # Downstream harm from bad kernels (was 4.0, higher stakes)
  theta: 0.5        # Even surplus split
  rho_a: 0.05       # Lower externality internalization at baseline (was 0.1)
  rho_b: 0.05       # Lower externality internalization at baseline (was 0.1)
  w_rep: 1.0        # Lower reputation weight (was 1.5)

# Governance: LIGHT baseline — room for levers to show effect
governance:
  # Audit: available but infrequent
  audit_enabled: true
  audit_probability: 0.05          # was 0.15 — audits are expensive
  audit_penalty_multiplier: 3.0
  audit_threshold_p: 0.5

  # Staking: OFF at baseline (sweep adds it)
  staking_enabled: false

  # Circuit breaker: OFF at baseline (sweep adds it)
  circuit_breaker_enabled: false

  # Reputation decays slowly
  reputation_decay_rate: 0.98      # was 0.95

  # Bandwidth: same
  bandwidth_cap: 5

  # Transaction tax: ZERO at baseline (sweep varies it)
  transaction_tax_rate: 0.0
  transaction_tax_split: 0.5

# Kernel oracle v2: correlated speedup-cheating + split test regime
kernel_oracle:
  enabled: true
  seed: 42
  difficulty_distribution:
    easy: 0.4
    medium: 0.4
    hard: 0.2

  # Functional tests (what the proxy sees)
  honest_functional_quality: 0.85
  opportunistic_functional_quality: 0.70
  adversarial_functional_quality: 0.95    # cheaters ace visible tests

  # OOD tests (hidden, revealed by audit)
  honest_ood_quality: 0.80
  opportunistic_ood_quality: 0.50
  adversarial_ood_quality: 0.30           # cheaters fail on OOD inputs

  # Speedup (correlated with cheating)
  honest_speedup_mean: 0.50              # good engineers write fast code
  opportunistic_speedup_mean: 0.40       # less skilled
  adversarial_speedup_mean: 0.45         # moderate base skill
  cheat_speedup_bonus: 0.40             # THE proxy gap source

  # Tolerance exploitation
  honest_tolerance_margin: 0.70
  opportunistic_tolerance_margin: 0.35
  adversarial_tolerance_margin: 0.05     # barely within tolerance

  # Detection rates
  adversarial_cheat_rate: 0.6
  audit_detection_rate: 0.8
  verifier_detection_rate: 0.3

# Agents: more adversarial pressure, fewer verifiers
agents:
  # Honest kernel authors: write correct AND fast code
  - type: honest
    count: 2
    name: kernel_author
    role: kernel_author
    config:
      quality_mean: 0.85
      speed_priority: 0.5

  # Opportunistic authors: cut corners on precision for speed
  - type: opportunistic
    count: 3
    name: fast_author
    role: kernel_author
    config:
      quality_mean: 0.45
      speed_priority: 0.9

  # Adversarial benchmark gamers: exploit proxy signals
  - type: adversarial
    count: 2
    name: benchmark_gamer
    role: kernel_author
    config:
      exploit_proxy: true
      target_signal: performance

  # Verifiers: scarce (verification is expensive)
  - type: verifier
    count: 1
    name: kernel_verifier
    role: verifier
    config:
      accuracy: 0.8

rate_limits:
  posts_per_epoch: 5
  interactions_per_step: 3
  votes_per_epoch: 20
  tasks_per_epoch: 5
  bounties_per_epoch: 3
  bids_per_epoch: 5

# Success criteria
success_criteria:
  min_epochs: 10
  min_agents: 5
  toxicity_threshold: 0.3
  quality_gap_min: 0.05

# Outputs
outputs:
  event_log: runs/kernel_market/v2/events.jsonl
  metrics_csv: runs/kernel_market/v2/metrics.csv
  plots_dir: runs/kernel_market/v2/plots
